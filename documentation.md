id: 68716a4f5887adf827c47e78_documentation
summary: Risk Management Framework Lab 2 Documentation
feedback link: https://docs.google.com/forms/d/e/1FAIpQLSfWkOK-in_bMMoHSZfcIvAeO58PAH9wrDqcxnJABHaxiDqhSA/viewform?usp=sf_link
environments: Web
status: Published
# QuLab: Risk Management Framework Lab 2

## Introduction and Setup
Duration: 0:05:00

Welcome to the QuLab Risk Management Framework Lab 2! This codelab will guide you through a Streamlit application designed to explore core concepts in financial risk management, specifically focusing on the Risk-Adjusted Return on Risk-Adjusted Capital (RARORAC) metric and portfolio quality visualization.

Understanding how financial institutions price risk and evaluate the profitability of deals is crucial. The **Risk Management Framework** is a structured approach used to identify, assess, mitigate, monitor, and report on risks. A key component within this framework is **Risk-Sensitive Pricing**, which ensures that the return generated from a deal is commensurate with the risk taken.

This application provides interactive tools to:
*   Calculate RARORAC for hypothetical deals based on various financial and risk parameters.
*   Save and compare different deal scenarios to understand the impact of changing inputs.
*   Visualize how the distribution of risk and return across a portfolio affects its overall quality, highlighting the consequences of risk-insensitive pricing.

By completing this lab, you will gain practical intuition into how RARORAC works, how different factors influence deal profitability from a risk-adjusted perspective, and why managing the risk/return profile of a portfolio is essential for long-term financial health.

<aside class="positive">
This application is built using **Streamlit**, a Python library that makes it easy to create and share beautiful, custom web apps for machine learning and data science. You'll see how Streamlit's interactive widgets and layout capabilities are used to build this financial modeling tool.
</aside>

### Application Structure

The application consists of a main `app.py` file and three separate Python files in an `application_pages` directory, one for each page of the application:
*   `app.py`: The main entry point, handling page navigation and displaying the introduction and formulas.
*   `application_pages/page1.py`: Implements the RARORAC Calculator.
*   `application_pages/page2.py`: Implements the Scenario Comparison tool.
*   `application_pages/page3.py`: Implements the Portfolio Quality Visualization.

This modular structure helps keep the code organized and makes it easier to manage different sections of the application.

### Running the Application

To run this application, you need Python installed, preferably in a virtual environment. You also need to install the required libraries: `streamlit`, `pandas`, `numpy`, and `altair`.

1.  Save the provided code snippets into the correct file structure:
    *   `app.py`
    *   `application_pages/page1.py`
    *   `application_pages/page2.py`
    *   `application_pages/page3.py`
2.  Open your terminal or command prompt.
3.  Navigate to the directory where you saved `app.py`.
4.  Install the required libraries:
    ```console
    pip install streamlit pandas numpy altair
    ```
5.  Run the application using the streamlit command:
    ```console
    streamlit run app.py
    ```
6.  Your web browser should open automatically to display the application.

## Understanding RARORAC Formulae
Duration: 0:05:00

The core of the first page and the entire concept revolves around the RARORAC formula. RARORAC helps financial institutions evaluate the risk-adjusted profitability of individual deals or lines of business. It compares the net income generated by a deal (adjusted for expected losses and operating costs) against the economic capital required to support the unexpected risks associated with that deal.

The application uses the following formulas, as presented on the main page:

$$
\text{Income\_From\_Deal} = \text{Loan\_Amount} \times \text{Interest\_Rate} + \text{Fees}
$$

This calculates the total revenue generated from the deal, combining interest earned over a period (implicitly assumed to be one year based on standard annual rates) and any upfront fees.

$$
\text{Operating\_Costs} = \text{Income\_From\_Deal} \times \text{Operating\_Cost\_Ratio}
$$

These are the expenses incurred in originating, servicing, and managing the deal, often expressed as a percentage of the deal's income.

$$
\text{Expected\_Loss} = \text{Loan\_Amount} \times \text{Expected\_Loss\_Rate}
$$

This represents the average or statistically predicted loss that is expected to occur over the life of the loan due to credit default or other events. It's a cost of doing business with a certain level of credit risk.

$$
\text{Net\_Risk\_Adjusted\_Reward} = \text{Income\_From\_Deal} - \text{Operating\_Costs} - \text{Expected\_Loss}
$$

This is the "numerator" of the RARORAC calculation. It's the profit generated from the deal after accounting for the cost of operations and the statistically expected credit losses.

$$
\text{Risk\_Adjusted\_Capital} = \text{Loan\_Amount} \times \text{Unexpected\_Loss\_Capital\_Allocation\_Factor}
$$

This is the "denominator" of the RARORAC calculation. It represents the economic capital that must be held against this deal to cover potential **unexpected** losses beyond the expected loss level. This capital acts as a buffer to absorb large, infrequent losses and is often derived from internal risk models (e.g., Value at Risk, Expected Shortfall at a high confidence level). The `Unexpected_Loss_Capital_Allocation_Factor` is a simplified representation of the amount of capital required per unit of loan amount for this specific deal's risk profile.

$$
\text{RARORAC} = \frac{\text{Net\_Risk\_Adjusted\_Reward}}{\text{Risk\_Adjusted\_Capital}}
$$

Finally, RARORAC is the ratio of the Net Risk-Adjusted Reward to the Risk-Adjusted Capital. It tells you how much risk-adjusted profit is generated for every unit of capital at risk to support unexpected losses. A higher RARORAC indicates a more profitable deal relative to the capital it consumes.

Financial institutions typically set a **Hurdle Rate**. This is the minimum acceptable RARORAC for a deal to be considered viable. If the calculated RARORAC is below the hurdle rate, the deal is considered insufficiently profitable for the risk involved.

## Using the RARORAC Calculator (Page 1)
Duration: 0:10:00

This step focuses on interacting with the first page of the application, the "RARORAC Calculator", implemented in `application_pages/page1.py`.

1.  Ensure the application is running (`streamlit run app.py`).
2.  In the sidebar on the left, make sure "RARORAC Calculator" is selected under "Navigation". This is usually the default page when the app starts.

The main area of the page displays the title, description, and the RARORAC formulae (which you explored in the previous step). The interactive inputs for the calculator are located in the **sidebar**.

3.  Locate the "Deal Parameters" section in the sidebar. Here you will find input fields for the key variables that feed into the RARORAC calculation:
    *   **Loan Amount ($)**: The principal amount of the loan.
    *   **Interest Rate (%)**: The annual interest rate. Remember this is entered as a percentage in the UI but used as a decimal in the calculation (the code handles this conversion).
    *   **Fees ($)**: Upfront fees.
    *   **Operating Cost Ratio (% of Income)**: The percentage of `Income_From_Deal` that goes towards operating costs. This is also entered as a percentage in the UI and converted to a decimal in the code.
    *   **Expected Loss Rate (% of Loan Amount)**: The percentage of `Loan_Amount` expected to be lost. Entered as a percentage, used as a decimal.
    *   **Unexpected Loss Capital Allocation Factor (% of Loan Amount)**: The percentage of `Loan_Amount` required as economic capital. Entered as a percentage, used as a decimal.
    *   **Hurdle Rate (%)**: The minimum acceptable RARORAC, expressed as a percentage. Entered as a percentage, used as a decimal.

4.  Observe the "Calculated Metrics" section in the main area. As you change any of the input parameters in the sidebar, the values displayed here update dynamically. Streamlit automatically re-runs the relevant parts of the script (`run_page1` function) whenever an input widget changes.

    *   **Income From Deal**: Shows the calculated income.
    *   **Operating Costs**: Shows the calculated operating costs.
    *   **Expected Loss**: Shows the calculated expected loss.
    *   **Net Risk-Adjusted Reward**: Displays the numerator of the RARORAC ratio.
    *   **Risk-Adjusted Capital**: Displays the denominator of the RARORAC ratio.
    *   **RARORAC**: Shows the final calculated RARORAC percentage.
    *   **Deal Outcome**: Indicates whether the calculated RARORAC meets or falls below the specified Hurdle Rate. The color of the text changes (green for meeting, red for below).

5.  Experiment with changing the input parameters.
    *   Increase the `Interest Rate` or `Fees`. How does this affect `Income From Deal`, `Net Risk-Adjusted Reward`, `RARORAC`, and `Deal Outcome`?
    *   Increase the `Operating Cost Ratio` or `Expected Loss Rate`. How do these affect `Net Risk-Adjusted Reward`, `RARORAC`, and `Deal Outcome`?
    *   Increase the `Unexpected Loss Capital Allocation Factor`. This represents taking on a deal with higher unexpected risk (e.g., a less creditworthy borrower or a more volatile asset). How does this affect `Risk-Adjusted Capital`, `RARORAC`, and `Deal Outcome`?
    *   Change the `Hurdle Rate`. How does this impact the `Deal Outcome` without changing the calculated RARORAC value itself?

<aside class="positive">
The informational boxes next to each input field and calculated metric (using `st.info()`) provide context and explain what each term means in this financial context. Pay attention to these explanations as you explore.
</aside>

The values you set and the resulting calculations on this page are stored in Streamlit's `st.session_state`. This allows the next page ("Scenario Comparison") to access these values.

## Saving and Comparing Scenarios (Page 2)
Duration: 0:07:00

This step explores the "Scenario Comparison" page, implemented in `application_pages/page2.py`. This page allows you to save the parameters and results from the RARORAC Calculator page and compare multiple scenarios in a table.

1.  In the sidebar, change the "Navigation" selection to "Scenario Comparison".

2.  This page has two main sections: "Save Current Scenario" and "Compare Scenarios".

3.  **Save Current Scenario:**
    *   Before coming to this page, ensure you calculated a RARORAC scenario on the "RARORAC Calculator" page by adjusting the parameters.
    *   Enter a descriptive name for your scenario in the "Scenario Name" text input field (e.g., "Base Case Loan", "High Risk - High Fee Loan").
    *   Click the "Save Current Scenario" button.
    *   You should see a success message if a scenario was available to save. If you haven't calculated a scenario on the first page, you will see a warning.

<aside class="positive">
The application uses <code>st.session_state</code> to store the saved scenarios. This data persists as long as your current browser session with the application is active. If you close the tab or restart the application, the saved scenarios will be lost.
</aside>

4.  Go back to the "RARORAC Calculator" page, modify some parameters (e.g., increase the Expected Loss Rate and the Interest Rate), and then navigate back to the "Scenario Comparison" page.

5.  Enter a new name for this modified scenario (e.g., "Higher Risk Higher Return") and click "Save Current Scenario" again.

6.  **Compare Scenarios:**
    *   After saving one or more scenarios, they will appear in the table in the "Compare Scenarios" section.
    *   The table (`st.dataframe`) displays the name of each saved scenario along with the key input parameters and the calculated results (`RARORAC` and `Deal Outcome`).
    *   Examine the table to easily compare the `RARORAC` and `Deal Outcome` for your different hypothetical deals. Notice how changing inputs (like increasing risk parameters vs. increasing revenue parameters) impacts the final risk-adjusted profitability.

7.  Use the "Clear All Scenarios" button to remove all saved scenarios from the session state. This is useful for starting a new comparison batch.

This scenario comparison feature helps demonstrate the importance of running different sensitivity analyses on potential deals and understanding how changes in underlying assumptions affect their risk-adjusted viability.

## Visualizing Portfolio Quality (Page 3)
Duration: 0:08:00

This step explores the "Portfolio Quality Visualization" page, implemented in `application_pages/page3.py`. This page moves from individual deals to a portfolio perspective, illustrating how the distribution of deals based on their risk and return characteristics impacts overall portfolio quality.

1.  In the sidebar, change the "Navigation" selection to "Portfolio Quality Visualization".

2.  This page generates synthetic data representing a portfolio of deals, each with a simulated 'Risk Score' and 'Return Ratio'. The relationship and distribution of these points on a scatter plot visualize the portfolio's quality.

3.  Locate the "Portfolio Parameters" section in the sidebar. Here you can control the characteristics of the generated portfolio:
    *   **Number of Deals**: The number of synthetic deals plotted. Increase this to see a more dense representation of the distribution.
    *   **Risk Score Range**: Defines the minimum and maximum possible 'Risk Score' for the generated deals. A higher score typically implies higher risk.
    *   **Return Ratio Range**: Defines the minimum and maximum possible 'Return Ratio' for the generated deals. This can be thought of as a simplified proxy for RARORAC or Net Risk-Adjusted Reward relative to some base (e.g., loan amount or capital).
    *   **Skewed Portfolio**: A checkbox that significantly impacts the data distribution.

4.  Observe the scatter plot displayed in the main area. Each point represents a hypothetical deal, plotted with 'Risk Score' on the x-axis and 'Return Ratio' on the y-axis.

5.  Experiment with the parameters:
    *   Start with the default settings (e.g., 100 deals, moderate ranges, 'Skewed Portfolio' unchecked). You should see a relatively even spread of points within the defined risk and return ranges.
    *   Check the "Skewed Portfolio" box. How does the distribution of points change? You should notice a concentration of deals towards the lower-right area of the plot (higher risk, lower return).

<aside class="negative">
A portfolio distribution skewed towards higher risk and lower return (as simulated when the 'Skewed Portfolio' box is checked) is indicative of poor risk-sensitive pricing or adverse selection. Such a portfolio is less profitable for the amount of risk taken and is vulnerable to significant losses.
</aside>

6.  Uncheck the "Skewed Portfolio" box again.
7.  Adjust the `Risk Score Range` or `Return Ratio Range`. See how the boundaries of the plotted points change.
8.  Increase the `Number of Deals` to see the distribution pattern more clearly.

This visualization helps reinforce the concept that not all deals contribute equally to portfolio value. Deals in the upper-left (lower risk, higher return) are highly desirable, while deals in the lower-right (higher risk, lower return) erode value from a risk-adjusted perspective. Effective risk management and risk-sensitive pricing aim to shift the portfolio distribution towards the upper-left or, at a minimum, ensure that higher risk is genuinely compensated by proportionally higher potential returns.

## Exploring the Code (Optional)
Duration: 0:10:00

This step provides a brief overview of the Python code behind the Streamlit application. You don't need to be a Streamlit expert to understand the core logic, but this step helps connect the UI elements you interacted with to the underlying code.

1.  Open the `app.py` file in a text editor.
    *   Notice the `st.set_page_config` call at the beginning - this sets the page title and layout.
    *   `st.sidebar.image` and `st.sidebar.divider` are used for the logo and visual separation in the sidebar.
    *   `st.title` and `st.markdown` are used for the main heading and explanatory text.
    *   `st.latex` is used to render the mathematical formulas nicely.
    *   `st.sidebar.selectbox` creates the navigation dropdown in the sidebar.
    *   The `if/elif` block checks the selected page and imports/runs the corresponding function from the `application_pages` directory (`run_page1`, `run_page2`, `run_page3`). This is how navigation is handled.
    *   The references are listed using `st.markdown`.

2.  Open `application_pages/page1.py`.
    *   The `calculate_rarorac_metrics` function encapsulates the core RARORAC calculation logic based on the formulas discussed earlier. It takes raw parameters and returns a dictionary of calculated metrics.
    *   The `run_page1` function is called by `app.py` when the "RARORAC Calculator" page is selected.
    *   Inside `run_page1`:
        *   `st.header` and `st.markdown` set up the page title and description.
        *   `st.sidebar.subheader` creates a section header in the sidebar.
        *   `st.sidebar.number_input` and `st.sidebar.info` are used for creating the input fields with tooltips in the sidebar. Notice how percentages are divided by 100 to convert them to decimals for calculation.
        *   The calculated metrics are displayed using `st.metric`. `st.columns` is used to arrange them horizontally. `st.info` provides explanations for each metric.
        *   The `Deal Outcome` is displayed using `st.markdown` with HTML formatting (`unsafe_allow_html=True`) to change the text color dynamically based on the outcome.
        *   `st.session_state['current_rarorac_params']` and `st.session_state['current_rarorac_results']` are used to store the current deal's details, making them accessible to `page2.py`.

3.  Open `application_pages/page2.py`.
    *   `st.session_state.saved_scenarios = {}` initializes an empty dictionary in session state the first time this page is loaded, to store saved scenarios.
    *   The `save_scenario_streamlit` function adds the current parameters and results (retrieved from session state) to the `st.session_state.saved_scenarios` dictionary.
    *   The `display_scenarios_comparison_streamlit` function formats the data from the `st.session_state.saved_scenarios` dictionary into a pandas DataFrame and displays it using `st.dataframe`. It also handles the case where no scenarios are saved.
    *   The `run_page2` function is called by `app.py` for this page.
    *   Inside `run_page2`:
        *   `st.text_input` gets the scenario name from the user.
        *   `st.button("Save Current Scenario")` triggers the saving logic when clicked. It checks if the required data exists in `st.session_state`.
        *   `st.button("Clear All Scenarios")` resets the `st.session_state.saved_scenarios` dictionary.
        *   The comparison table is displayed by calling `display_scenarios_comparison_streamlit`.

4.  Open `application_pages/page3.py`.
    *   The `generate_portfolio_data` function creates the synthetic data. It uses `numpy.random.uniform` for a uniform distribution and `numpy.random.beta` for the skewed distribution. Beta distribution is often used to model variables constrained to a finite range (like 0 to 1) and can be shaped to be skewed.
    *   The `run_page3` function is called by `app.py` for this page.
    *   Inside `run_page3`:
        *   `st.sidebar.number_input`, `st.sidebar.slider`, and `st.sidebar.checkbox` are used for the interactive input widgets in the sidebar for controlling portfolio generation parameters.
        *   `generate_portfolio_data` is called with the user's selected parameters.
        *   `altair.Chart` is used to create the scatter plot. `encode` maps the 'Risk_Score' to the x-axis and 'Return_Ratio' to the y-axis. `tooltip` ensures that hovering over points shows their values. `.properties` sets the title. `.interactive()` enables zooming and panning on the chart.
        *   `st.altair_chart` renders the Altair chart in the Streamlit application.

This brief code tour shows how Streamlit widgets capture user input, how Python functions perform the calculations and data generation, and how Streamlit's display elements (`st.metric`, `st.dataframe`, `st.altair_chart`) visualize the results. The use of `st.session_state` is key for sharing data (current deal, saved scenarios) between the different pages.

## Conclusion
Duration: 0:03:00

Congratulations! You have successfully explored the QuLab Risk Management Framework Lab 2 application.

Through this lab, you've interacted with key concepts in financial risk management:
*   **RARORAC:** Understanding how risk is explicitly factored into deal profitability calculations, ensuring that returns are adequate for the capital at risk.
*   **Risk-Sensitive Pricing:** Seeing how adjusting deal parameters (especially those related to risk and required capital) directly impacts the RARORAC and the decision of whether a deal meets the required hurdle rate.
*   **Portfolio Quality:** Visualizing how the collection of individual deals, based on their risk/return profiles, forms an overall portfolio distribution, and understanding how risk-insensitive pricing can lead to a portfolio skewed towards undesirable (high risk, low return) deals, potentially eroding firm value.

This application provides a simplified yet powerful illustration of these fundamental principles that guide decision-making in financial institutions. Effective risk management isn't just about avoiding losses; it's also about ensuring that risk-taking is adequately compensated, contributing positively to risk-adjusted profitability and overall portfolio quality.

Feel free to continue experimenting with the parameters in the application to build further intuition about these concepts. You can also explore the provided code further to understand the implementation details.

<aside class="positive">
Understanding risk-adjusted performance metrics like RARORAC is vital for anyone involved in lending, investment, or financial analysis, as it provides a more complete picture of performance than return metrics alone.
</aside>
